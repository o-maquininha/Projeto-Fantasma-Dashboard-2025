---
# Nome do arquivo PDF gerado na pasta resultado
output-file: "Entrega 1"
---

```{r setup}
#| include: false
source("rdocs/entrega_1.R")
knitr::opts_chunk$set(echo = TRUE, cache=T, message=F, warning=F, error=F)
if (!require("pacman")) install.packages("pacman")
pacman::p_load("readxl", "tidyverse", "knitr", "kableExtra")
options(scipen=0)
```

```{r echo=FALSE}
source("rdocs/source/packages.R")

relatorio_vendas <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "relatorio_vendas")
info_vendas <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "infos_vendas")
info_produtos <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "infos_produtos")
info_funcionarios <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "infos_funcionarios")
info_cidades <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "infos_cidades")
info_clientes <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "infos_clientes")
info_lojas <- read_excel(path = "relatorio_old_town_road.xlsx", sheet = "infos_lojas")

relatorio_vendas$Date <- ymd(relatorio_vendas$Date)

relatorio_vendas <- relatorio_vendas %>% 
  inner_join(info_vendas, by = c("SaleID" = "Sal3ID")) %>% 
  inner_join(info_lojas, by = c("StoreID" = "Stor3ID")) %>% 
  inner_join(info_cidades, by = c("CityID" = "C1tyID")) %>% 
  inner_join(info_produtos, by = c("ItemID" = "Ite3ID")) %>% 
  inner_join(info_clientes, by = c("ClientID" = "Cli3ntID"))

relatorio_vendas <- relatorio_vendas %>% 
  mutate(ano = year(Date)) %>%
  mutate(UnityPrice = UnityPrice * 5.31) %>% 
  mutate(receitaVenda = Quantity * UnityPrice) %>% 
  mutate(Height_dm = Height_dm * 10) %>% 
  mutate(Weight_lbs = Weight_lbs * 0.453592) %>% 
  rename(altura_cm = Height_dm,
         peso_kg = Weight_lbs) %>% 
  mutate(IMC = peso_kg/(altura_cm/100)^2)
```

# Objetivo

Esse template foi criado para o alocado conseguir observar como ficaria sua análise o arquivo principal. É daqui que o gerente de projetos irá copiar a análise e inserir no documento principal que gerará o relatório estatístico.

# Introdução

# Método

\ \ \ \ Neste estudo, serão utilizados dados fictícios fornecidos pela ESTAT - Consultoria Estatística, com o objetivo de avaliar o nível de conhecimento do Trainee. Foram aplicados os seguintes métodos descritivos e inferenciais: [...] para a análise das variáveis em estudo (conferir Anexo 1).

# Análises

\ \ \ \ O conjunto de dados consiste em 19.885 observações de compras feitas por 1990 **clientes** de 10 tipos de **produtos** em 18 **lojas** distintas nas 5 **cidades** da região de interesse.

## Análise 1

```{r}
#| echo: false

tabela1 <-  relatorio_vendas %>% 
  group_by(ano, NameStore, NameProduct, NameCity) %>%
  summarise(
    receitaAnual = sum(receitaVenda)
  ) #%>% View

tabela2 <- tabela1 %>% 
  group_by(NameStore) %>% 
  summarise(
    Média = mean(receitaAnual),
    Mediana = median(receitaAnual),
    DP = sd(receitaAnual),
  ) %>% 
  arrange(desc(Média)) #%>% View

tabela3 <- relatorio_vendas %>%
  group_by(ano) %>% 
  summarise(
    receitaAnual = sum(receitaVenda)/18
  ) #%>% View

tabela4 <- relatorio_vendas %>% 
  group_by(NameProduct) %>%
  summarise(
    Quantidade = sum(Quantity)
    ) %>% 
  arrange(desc(Quantidade)) #%>% View

tabela5 <- tabela1 %>% 
  group_by(NameProduct) %>%
  summarise(
    Média = mean(receitaAnual),
    Mediana = median(receitaAnual),
    DP = sd(receitaAnual),
  ) %>% 
  arrange(desc(Média)) #%>% View

tabela6 <- relatorio_vendas %>% 
  group_by(NameCity) %>%
  summarise(
    Quantidade = sum(Quantity)
    ) %>% 
  arrange(desc(Quantidade)) #%>% View

tabela7 <- tabela1 %>% 
  group_by(NameCity) %>%
  summarise(
    Média = mean(receitaAnual),
    Mediana = median(receitaAnual),
    DP = sd(receitaAnual),
  ) %>% 
  arrange(desc(Média)) #%>% View

tabela8 <- tabela1 %>% 
  filter(ano %in% c(1880, 1889)) %>%
  group_by(NameCity) %>%
  summarise(
    "Taxa de cerscimento (%)" = ((sum(receitaAnual[ano == 1889]) -sum(receitaAnual[ano == 1880]))/sum(receitaAnual[ano == 1880])) * 100
  ) %>% arrange(desc(`Taxa de cerscimento (%)`)) #%>% View

```

\ \ \ \ O objetivo desta análise é compreender o comportamento das **lojas** ao longo da série temporal por meio da **receita anual** e da **receita média**. A receita anual corresponde à soma da quantidade vendida multiplicada pelo preço unitário de cada item comercializado em determinado ano, enquanto a receita média é a soma da receita anual dividido pela quantidade de lojas na região. Foram utilizados gráficos de dispersão para facilitar a visualização e a análise dos dados. Na Figura 1, o gráfico é apresentado em facetas e mostra a receita anual de cada loja, com o ano no eixo x e a receita total anual no eixo y. Já na Figura 2, o gráfico apresenta a receita média. A Tabela 1 apresenta a média, a mediana e o desvio-padrão da receita de cada loja em todo o período, enquanto a Tabela 2 mostra a receita média em reais ao longo dos anos de 1880 a 1889.

\vspace{.2cm}
```{r}
#| echo: false
#| label: fig-grafico-1
#| fig-cap: "Receita anual das lojas"
#| fig-width: 12
#| fig-height: 8

relatorio_vendas %>%
  group_by(ano, NameStore) %>% 
  summarise(receita = sum(receitaVenda)) %>% 
  ggplot(aes(ano, receita)) +
  scale_x_continuous(breaks = seq(1880, 1889, by = 2)) +
  # geom_smooth(method = lm, se = FALSE, colour = "lightgrey") +
  geom_point(size = 1.5, colour = "#A11D21") +
  geom_line(colour = "#A11D21") +
  facet_wrap(~NameStore, nrow = 3) +
  labs(x = "Ano", y = "Receita") +
  theme_estat()
```

\newpage

```{r}
#| echo: false
#| results: asis
#| label: tbl-tabela-1
#| tbl-cap: "Resumo da receita das lojas em todo o período"
#| cap-location: top

colnames(tabela2)[1] <- "Loja"
tabela2 %>% kable(digits = 2)
```


\ \ \ \ As 18 lojas da região apresentam comportamentos diversos, sendo que a maioria registrou crescimento na receita anual ao final do período em relação ao primeiro ano da série. A loja **Saloon** destaca-se das demais, em que sua receita anual apresentou uma queda significativa durante o mesmo intervalo. As lojas que tiveram maior receita média nos 10 anos em estudo foram **Ferraria Apache**, **Loja Ouro Fino** e **Loja TendTudo**, já as que tiveram a menor receita méida foram **Banco Careca**, **Loja Riacho Prateado** e **Saloon Rastro de Poeira**.

\newpage

```{r}
#| echo: false
#| label: fig-grafico-2
#| fig-cap: Receita média da região

relatorio_vendas %>% 
  group_by(ano) %>% 
  summarise(receita = sum(receitaVenda)/18) %>%
  ggplot(aes(ano, receita)) +
  scale_x_continuous(breaks = c(1880:1889)) +
  # geom_smooth(method = lm, se = FALSE, colour = "lightgrey") +
  geom_point(size = 1.5, colour = "#9D1C18") +
  geom_line(colour = "#9D1C18") +
  labs(x = "Ano", y = "Receita Média") +
  theme_estat()

```

```{r}
#| echo: false
#| results: asis
#| label: tbl-tabela-2
#| tbl-cap: "Receita méida da região nos anos de 1880 a 1889"
#| cap-location: top

colnames(tabela3) <- c("Ano", "Receita média (R$)")
tabela3 %>% kable(digits = c(0, 2))
```

\ \ \ \ A receita média da região apresentou um crescimento expressivo ao longo do período analisado, com um aumento total de R\$49.610,10 desde o início da série histórica. Esses resultados indicam que a região apresenta **grande potencial** de investimento.

\newpage

## Análise Extra

### Análise dos produtos

\ \ \ \ O objetivo desta análise é examinar mais detalhadamente a **receita anual** e a **receita méida** por **produto** na região, bem como a **quantidade vendida**.

```{r}
#| echo: false
#| label: fig-grafico-3
#| fig-cap: Receita anual por produto
#| fig-width: 12
#| fig-height: 8

relatorio_vendas %>%
  group_by(ano, NameProduct) %>% 
  summarise(receita = sum(receitaVenda)) %>%
  ggplot(aes(ano,receita)) +
  scale_x_continuous(breaks = seq(1880, 1889, by = 2)) +
  # geom_smooth(method = lm, se = FALSE, colour = "lightgrey") +
  geom_point(size = 1.5, colour = "#9D1C18") +
  geom_line(colour = "#9D1C18") +
  facet_wrap(~NameProduct, nrow = 2) +
  labs(x = "Ano", y = "Receita") +
  theme_estat()
```

```{r}
#| echo: false
#| results: asis
#| label: tbl-tabela-3
#| tbl-cap: "Quantidade de produtos vendidos nos anos de 1880 a 1889"
#| cap-location: top

colnames(tabela4) <- c("Produto", "Quantidade")
tabela4 %>% kable()
```

```{r}
#| echo: false
#| results: asis
#| label: tbl-tabela-4
#| tbl-cap: "Resumo da receita dos produtos nos anos de 1880 a 1889"
#| cap-location: top

colnames(tabela5)[1] <- "Produto"
tabela5 %>% kable(digits = 2)
```

\ \ \ \ Dos 10 produtos disponíveis, o **Cavalo** apresentou a maior média de receita, mesmo sendo o menos vendido. Esse resultado se deve ao elevado preço unitário do produto, de R\$ 2.981,99.  O **Chapéu de Couro** foi o item mais vendido na região, seguido pela **Espingarda** e pela **Colt .45**. É importante observar que a soma das quantidades vendidas das duas armas foi de 10.295 unidades, enquanto o total de **Munições** vendidas foi de apenas 4.862. Esse contraste pode indicar que os consumidores adquirem munições em outras regiões ou não sentem necessidade de comprá-las com frequência após a aquisição da arma. Além disso, nota-se que foram vendidas mais do que o dobro de **Selas** em relação ao número de **Cavalos**, o que pode sugerir que as **Selas** vendidas na região são de baixa qualidade ou mal cuidadas.

\newpage

### Análise das cidades

\ \ \ \ Nessa análise iremos aprofundar o entendimento de cada **cidade** observando a **receita anual** e a **receita média** assim como a **taxa de crescimento econômico**.

```{r}
#| echo: false
#| label: fig-grafico-4
#| fig-cap: Receita anual por cidade

relatorio_vendas %>%
  group_by(ano, NameCity) %>% 
  summarise(receita = sum(receitaVenda)) %>%
  ungroup() %>% 
  select(ano, NameCity, receita) %>%
  ggplot(aes(ano,receita, colour = NameCity)) +
  scale_x_continuous(breaks = seq(1880, 1889, by = 2)) +
  #geom_smooth(method = lm, se = FALSE, colour = "lightgrey") +
  geom_point(size = 3, alpha = .5) +
  geom_line(size = 1) +
  #facet_wrap(~NameCity, nrow = 2) +
  labs(x = "Ano", y = "Receita", colour = "Cidade") +
  theme_estat() +
  theme(legend.position = "right")

```


```{r}
#| echo: false
#| results: asis
#| label: tbl-tabela-5
#| tbl-cap: "Resumo da receita das cidades nos anos de 1880 a 1889"
#| cap-location: top

colnames(tabela7)[1] <- "Cidade"
tabela7 %>% kable(digits = 2)
```

```{r}
#| echo: false
#| results: asis
#| label: tbl-tabela-6
#| tbl-cap: "Taxa de crescimento econômico (%) das cidades entre 1880 e 1889"
#| cap-location: top

colnames(tabela8)[1] <- "Cidade"
tabela8 %>% kable(digits = 2)
```

\ \ \ \ A cidade de **Rio Bravo** apresentou o maior crescimento em receita anual ao longo do período analisado, destacando-se também por possuir o maior número de vendas (11290) e a maior receita média (R\$2.527,90). Observa-se que **Canoa Quebrada** realizou apenas 8.031 vendas nos 10 anos em análise, mas registrou a segunda maior receita média. Toodas As cidades demonstram bom crescimento econômico e se mostram **promissoras** para investimentos futuros, porém as cidades com maior taxa de crescimento econômico foi **Rio Bravo**, **Canoa Quebrada** e **Sussuro de Pedra**.

## Análise 2

```{r}
#| echo: false
#| warning: false

p_media <- mean(relatorio_vendas$peso_kg)
p_sd <- sd(relatorio_vendas$peso_kg)
h_media <- mean(relatorio_vendas$altura_cm)
h_sd <- sd(relatorio_vendas$altura_cm)

np_test <- ks.test(relatorio_vendas$peso_kg, "pnorm",
                   mean = p_media,
                   sd = p_sd)
nh_test <- ks.test(relatorio_vendas$altura_cm, "pnorm",
                   mean = h_media,
                   sd = h_sd)

p_est <- np_test$statistic
h_est <- nh_test$statistic

cor_test <- cor.test(relatorio_vendas$peso_kg, relatorio_vendas$altura_cm, conf.level = .95)
cor_hat <- cor_test$estimate
cor_IC <- cor_test$conf.int

quadro1 <- relatorio_vendas %>% 
  summarize(`Média` = round(mean((peso_kg)),2),
            `Desvio Padrão` = round(sd(peso_kg),2),
            `Mínimo` = round(min(peso_kg),2),
            `1º Quartil` = round(quantile(peso_kg, probs = .25),2),
            `Mediana` = round(quantile(peso_kg, probs = .5),2),
            `3º Quartil` = round(quantile(peso_kg, probs = .75),2),
            `Máximo` = round(max(peso_kg),2)) %>% t()

quadro2 <- relatorio_vendas %>% 
  summarize(`Média` = round(mean((altura_cm)),2),
            `Desvio Padrão` = round(sd(altura_cm),2),
            `Mínimo` = round(min(altura_cm),2),
            `1º Quartil` = round(quantile(altura_cm, probs = .25),2),
            `Mediana` = round(quantile(altura_cm, probs = .5),2),
            `3º Quartil` = round(quantile(altura_cm, probs = .75),2),
            `Máximo` = round(max(altura_cm),2)) %>% t()
```

\ \ \ \ O objetivo desta análise é investigar se existe relação linear entre o **peso** e a **altura** dos clientes, em que o peso foi convertido para quilogramas (multiplicando o valor em libras por 0.453592) e a altura convertido para centímetros (multiplicando o valor em decímetros por 10).

```{r}
#| echo: false
#| label: fig-grafico-6
#| fig-cap: Disperssão entre peso e altura dos clientes

relatorio_vendas %>% 
  group_by(ClientID) %>% 
  ggplot(aes(x = peso_kg, y = altura_cm)) +
  geom_point(colour = "#A11D21", alpha = .3) +
  # geom_jitter(width = .5, height = .5, colour = "#A11D21", alpha = .3) +
  labs(x = "Peso (kg)", y = "altura (cm)") +
  theme_estat()
```

\newpage

```{r}
#| echo: false
#| results: asis

cat("Quadro 1: Principais métricas do peso (kg)\n\n")

colnames(quadro1) <- "Valor"
quadro1 %>% as.data.frame() %>% rownames_to_column("Estatística") %>% kable(digits = 2)
```
\vspace{.2cm}

```{r}
#| echo: false
#| results: asis

cat("Quadro 2: Principais métricas da altura (cm)\n\n")

colnames(quadro2) <- "Valor"
quadro2 %>% as.data.frame() %>% rownames_to_column("Estatística") %>% kable(digits = 2)
```

\ \ \ \ Para realizar a análise, primeiro foram realizados dois testes de aderência de Kolmogorov–Smirnov a fim de verificar normalidade das variáveis. As hipóteses nulas $H_{0}$ consideram que o **peso** dos clientes provém de uma população normalmente distribuída com média igual a 75.21048 e variância igual a 140.4506, e que a **altura** dos clientes provém de uma população normalmente distribuída com média igual a 171.0633 e  variância igual a 97.70323. As hipóteses alternativas $H_{1}$ afirmam que os dados não seguem essas distribuições propostas. As estatísticas de teste foram $D_{p} = 0.01888389$ e $D_{t} = 0.01577982$, com p-valores de $1.3 \times 10^{-6}$ e $1.0 \times 10^{-4}$, respectivamente, sugerindo que os dados seguem uma distribuição aproximadamente normal. Nos gráficos seguintes podemos observar melhor a suposição de normalidade.

```{r}
#| echo: false
#| label: fig-grafico-7
#| fig-cap: Verificação da suposição de normalidade para a variável peso

relatorio_vendas %>% 
  ggplot(aes(x = peso_kg)) +
  geom_histogram(aes( y = ..density..), binwidth = 5, fill = "#A11D21", colour = "white") +
  labs(x = "Peso (kg)", y = "Densidade") +
  stat_function(fun = dnorm,
                args = list(mean = mean(relatorio_vendas$peso_kg),
                            sd = sd(relatorio_vendas$peso_kg)),
                colour = "#003366", size = 1, linetype = "dashed") +
  theme_estat()
```

```{r}
#| echo: false
#| label: fig-grafico-8
#| fig-cap: Verificação da suposição de normalidade para a variável altura

relatorio_vendas %>% 
  ggplot(aes(x = altura_cm)) +
  geom_histogram(aes( y = ..density..), binwidth = 5, fill = "#A11D21", colour = "white") +
  labs(x = " altura (cm)", y = "Densidade") +
  stat_function(fun = dnorm,
                args = list(mean = mean(relatorio_vendas$altura_cm),
                            sd = sd(relatorio_vendas$altura_cm)),
                colour = "#003366", size = 1, linetype = "dashed") +
  theme_estat()
```

\ \ \ \ Em seguida, após a verificação da normalidade das variáveis, aplicou-se o teste de correlação de Pearson sob a hipótese nula $H_{0}: \rho = 0$ contra a hipótese alternativa $H_{1}: \rho \neq 0$, ao nível de significância de 5%. O resultado obtido foi $\text{p-valor} < 2.2 \times 10^{-16}$, indicando evidência significativa de correlação linear entre as variáveis. O estimador do coeficiente de correlação foi $\hat{\rho} = 0.6931284$, e o intervalo de confiança a 95% foi dado por $IC_{\rho;\ 0.95} = [0.6858365;\ 0.7002811]$.
\ \ \ \ O estimador da correlação de Pearson ($0.5 < \hat{\rho} < 0.7$) indica, na população de clientes, uma relação linear positiva moderada, quase alta, entre o **peso** e a **altura**. Isso é, à medida que a altura dos clientes aumenta, o peso também tende a aumentar. O $\text{p-valor}$ muito baixo fornece evidência estatistica que a correlação linear é não nula, sugerindo que que a relação observada dificilmente ocorreu ao acaso. O intervalo de confiança indica que a verdadeira correlação populacional provavelmente está entre $[0.6858; 0.7003]$. Assim, podemos conlcuir que em geral, **clientes mais altos pesam mais**.

<!-- ## Análise Extra -->

<!-- ### Análise do IMC -->

<!-- \ \ \ \ O objetivo desta análise é examinar mais detalhadamente o **Índice de Massa Corporal (IMC)** dos **clientes**, considerando também a diferença por **gênero**. -->

<!-- ```{r} -->
<!-- #| echo: false -->
<!-- #| label: fig-grafico-9 -->

<!-- relatorio_vendas %>% -->
<!--   ggplot(aes(x = IMC)) + -->
<!--   geom_histogram(binwidth = 1, fill = "#A11D21", colour = "white") + -->
<!--   labs(x = "IMC", y = "Frequência", title = "Distribuição do IMC dos clientes") + -->
<!--   theme_estat() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #| echo: false -->
<!-- #| label: fig-grafico-10 -->

<!-- relatorio_vendas %>% -->
<!--   ggplot(aes(x = IMC)) + -->
<!--   geom_histogram(binwidth = 1, aes(fill = Sex), colour = "white", position = "dodge") + -->
<!--   labs(x = "IMC", y = "Frequência", title = "Distribuição do IMC dos clientes por gênero", fill = "Gênero") + -->
<!--   theme_estat() -->
<!-- ``` -->



## Análise 3


# Conclusão

# Anexo

1. Dicionário das variáveis do banco de dados

- ClienteID: Chave do cliente 
- Name: O nome do cliente 
- Age: A idade do cliente em anos 
- Sex: Sexo do Cliente 
- Height_dm: A altura do cliente em decímetros 
- Weight_lbs: O peso do cliente, em libras 
- Anual_Income_usd: Renda do cliente anualmente em dólares 
- CityID: Chave da cidade 
- NameCity: Nome da cidade 
- EmployeeID: Chave do funcionário 
- EmployeeName: Nome do funcionário 
- StoreID: Chave da loja 
- StoreName: Nome da loja 
- CityID: Chave da cidade 
- ItemID: Chave do produto 
- NameProduct: Nome do produto 
- UnityPrice: Preço unitário do produto em dólores 
- SaleID: Chave da venda 
- ItemID: Chave do produto 
- SaleID: Chave da venda 
- Date: A data da ocorrência da venda (YYYY-MM-DD) 
- StoreID: Chave da loja 
- ClientID: Chave do cliente 
- Quantity: Quantidade comprada deste produto